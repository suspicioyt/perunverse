<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Miner | Perun Gameverse</title>
    <link rel="icon" type="image/x-icon" href="https://suspicioyt.github.io/perunverse/logo/gameverse.png">
    <link rel="stylesheet" href="https://suspicioyt.github.io/perunverse/gameverse/style/public.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            padding: 0;
        }
        .container {
            margin-top: 50px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .bitcoin-icon {
            width: 100px;
            cursor: pointer;
            transition: transform 0.1s ease;
            user-select: none;
        }
        .bitcoin-icon:hover {
            transform: scale(1.1);
        }
        .bitcoin-icon:active {
            transform: scale(0.95);
        }
        .score {
            font-size: 2rem;
            margin: 20px 0;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .button-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        button {
            background-color: #f7931a;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s, transform 0.1s;
        }
        button:hover {
            background-color: #e67e00;
            transform: scale(1.05);
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
            transform: none;
        }
        input {
            padding: 10px;
            font-size: 1rem;
            margin: 10px;
            border: none;
            border-radius: 5px;
            width: 200px;
            background-color: #2a2a2a;
            color: white;
        }
        input:focus {
            outline: none;
            box-shadow: 0 0 5px #f7931a;
        }
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f7931a;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
        .sync-indicator {
            font-size: 1.5rem;
            min-width: 24px; /* Prevent layout shift when indicator is empty */
        }
        .sync-indicator.fa-check {
            color: #00cc00; /* Green checkmark */
        }
        .sync-indicator.fa-spinner {
            color: #f7931a; /* Orange spinner to match theme */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bitcoin Miner</h1>
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg" alt="Bitcoin" class="bitcoin-icon" id="bitcoin" aria-label="Click to mine Bitcoin">
        <div class="score" id="score">
            <span id="score-value">0.00000000 BTC</span>
            <i class="sync-indicator" id="btcSyncIndicator"></i>
        </div>
        <div class="button-container">
            <button id="exchangeBtcToPlnButton" aria-label="Exchange Bitcoin to PLN">Wymień BTC na PLN</button>
            <input type="number" id="btcAmountInput" placeholder="Ile BTC wymienić?" step="0.00000001" min="0" aria-label="Amount of Bitcoin to exchange">
            <div id="btcOutput">Otrzymasz: 0 PLN</div>
        </div>
        
        <div class="button-container">
            <button id="exchangePlnToBtcButton" aria-label="Exchange PLN to Bitcoin">Wymień PLN na BTC</button>
            <input type="number" id="plnAmountInput" placeholder="Ile PLN wymienić?" step="0.01" min="0" aria-label="Amount of PLN to exchange">
            <div id="plnOutput">Otrzymasz: 0 BTC</div>
        </div>

        <div class="score" id="perunPLN">
            <span id="pln-value">0.00 PLN</span>
            <i class="sync-indicator" id="plnSyncIndicator"></i>
        </div>
        <div class="score" id="perunBTC">Kurs BTC do PLN: Ładowanie...</div>
    </div>
    <div class="notification" id="notification">Zwolnij! Za szybkie klikanie!</div>
    <script src="https://suspicioyt.github.io/perunverse/data/data.js"></script>
    <script src="https://suspicioyt.github.io/perunverse/data/localData.js"></script>
    <script>
        (async function initialize() {
            // Pomocniczy fallback dla userData, jeśli skrypt data.js nie załadowałby się
            if (!window.userData) {
                window.userData = {
                    getData: (sec, key) => null,
                    setData: async (sec, key, val) => {},
                    initializeUserData: async () => {}
                };
            }

            try {
                await window.userData.initializeUserData();
            } catch (e) {
                console.error('Failed to initialize userData:', e);
            }

            // --- INICJALIZACJA DANYCH ---
            // Bitcoiny pobieramy z localData (localStorage)
            let score = parseFloat(getLocalData('gameverse', 'bitcoin')) || 0;
            // PLN pobieramy z userData (chmura/sesja)
            let pln = parseFloat(window.userData.getData('profile', 'money')) || 0;

            let btcToPlnRate = 300000;
            let lastFetchTime = 0;
            let lastClickTime = 0;
            let lastExchangeTime = 0;
            const CLICK_COOLDOWN = 100;
            const EXCHANGE_COOLDOWN = 500;
            const RATE_CACHE_DURATION = 5 * 60 * 1000;

            // Elementy DOM (pozostają bez zmian)
            const scoreValueElement = document.getElementById('score-value');
            const plnValueElement = document.getElementById('pln-value');
            const rateElement = document.getElementById('perunBTC');
            const bitcoinIcon = document.getElementById('bitcoin');
            const btcAmountInput = document.getElementById('btcAmountInput');
            const plnAmountInput = document.getElementById('plnAmountInput');
            const notification = document.getElementById('notification');

            const formatNumber = (num, decimals) => num.toFixed(decimals).replace(/\.?0+$/, '');

            function showNotification(message) {
                notification.textContent = message;
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', 2000);
            }

            // --- LOGIKA ZAPISU ---

            // Zapis Bitcoinów (Lokalnie)
            function saveBtcLocal() {
                setLocalData('gameverse', 'bitcoin', score.toFixed(8));
                updateLocalDisplays();
                console.log('BTC saved locally:', score);
            }

            // Zapis PLN (Chmura)
            async function savePlnCloud() {
                await window.userData.setData('profile', 'money', pln.toFixed(2));
                updateLocalDisplays();
                console.log('PLN saved to cloud:', pln);
            }

            // --- OBSŁUGA KURSÓW I WYŚWIETLANIA ---

            async function fetchBtcRate() {
                const now = Date.now();
                if (now - lastFetchTime < RATE_CACHE_DURATION) return;
                try {
                    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=pln');
                    const data = await response.json();
                    btcToPlnRate = data.bitcoin.pln;
                    lastFetchTime = now;
                    rateElement.textContent = `Kurs BTC do PLN: ${formatNumber(btcToPlnRate, 2)} PLN`;
                } catch (e) {
                    rateElement.textContent = `Kurs BTC do PLN: ${formatNumber(btcToPlnRate, 2)} PLN (cached)`;
                }
            }

            function updateLocalDisplays() {
                scoreValueElement.textContent = `${formatNumber(score, 8)} BTC`;
                plnValueElement.textContent = `${formatNumber(pln, 2)} PLN`;
                updateExchangeOutputs();
            }

            function updateExchangeOutputs() {
                const btcAmount = parseFloat(btcAmountInput.value) || 0;
                const plnAmount = parseFloat(plnAmountInput.value) || 0;

                document.getElementById('btcOutput').textContent = btcAmount <= score && btcAmount > 0 
                    ? `Otrzymasz: ${formatNumber(btcAmount * btcToPlnRate, 2)} PLN`
                    : btcAmount > score ? 'Za mało BTC' : 'Otrzymasz: 0 PLN';

                document.getElementById('plnOutput').textContent = plnAmount <= pln && plnAmount > 0 
                    ? `Otrzymasz: ${formatNumber(plnAmount / btcToPlnRate, 8)} BTC`
                    : plnAmount > pln ? 'Za mało PLN' : 'Otrzymasz: 0 BTC';
            }

            // --- EVENT LISTENERS ---

            bitcoinIcon.addEventListener('click', () => {
                const now = Date.now();
                if (now - lastClickTime < CLICK_COOLDOWN) return;
                lastClickTime = now;

                score += 0.00000001;
                saveBtcLocal(); // Zapis do localStorage
            });

            document.getElementById('exchangeBtcToPlnButton').addEventListener('click', async () => {
                if (Date.now() - lastExchangeTime < EXCHANGE_COOLDOWN) return;
                lastExchangeTime = Date.now();

                const amountBtc = btcAmountInput.value === '' ? score : parseFloat(btcAmountInput.value) || 0;
                if (amountBtc <= score && amountBtc > 0) {
                    pln += amountBtc * btcToPlnRate;
                    score -= amountBtc;
                    btcAmountInput.value = '';

                    saveBtcLocal();    // Zapisz BTC lokalnie
                    await savePlnCloud(); // Zapisz PLN w chmurze
                } else {
                    showNotification('Błąd ilości BTC');
                }
            });

            document.getElementById('exchangePlnToBtcButton').addEventListener('click', async () => {
                if (Date.now() - lastExchangeTime < EXCHANGE_COOLDOWN) return;
                lastExchangeTime = Date.now();

                const amountPln = plnAmountInput.value === '' ? pln : parseFloat(plnAmountInput.value) || 0;
                if (amountPln <= pln && amountPln > 0) {
                    score += amountPln / btcToPlnRate;
                    pln -= amountPln;
                    plnAmountInput.value = '';

                    saveBtcLocal();    // Zapisz BTC lokalnie
                    await savePlnCloud(); // Zapisz PLN w chmurze
                } else {
                    showNotification('Błąd ilości PLN');
                }
            });

            // Obsługa wejść (walidacja)
            btcAmountInput.addEventListener('input', () => {
                if (parseFloat(btcAmountInput.value) > score) btcAmountInput.value = score;
                updateExchangeOutputs();
            });

            plnAmountInput.addEventListener('input', () => {
                if (parseFloat(plnAmountInput.value) > pln) plnAmountInput.value = pln;
                updateExchangeOutputs();
            });

            // Inicjalizacja startowa
            await fetchBtcRate();
            updateLocalDisplays();
            setInterval(fetchBtcRate, 60000);
        })();
    </script>
</body>
</html>