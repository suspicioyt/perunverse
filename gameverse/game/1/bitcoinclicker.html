<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Miner | Perun Gameverse</title>
    <link rel="icon" type="image/x-icon" href="https://suspicioyt.github.io/perunverse/logo/gameverse.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --btc-color: #f7931a;
            --pln-color: #2ecc71;
            --bg-dark: #0f0f0f;
            --card-bg: #1a1a1a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: white;
            margin: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .game-layout {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            width: 95vw;
            max-width: 1200px;
            gap: 20px;
            align-items: center;
        }

        .side-panel {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            border: 1px solid #333;
            text-align: center;
        }

        .center-panel {
            text-align: center;
            position: relative;
        }

        .bitcoin-wrapper {
            position: relative;
            display: inline-block;
        }

        .bitcoin-icon {
            width: 220px;
            cursor: pointer;
            transition: transform 0.05s;
            user-select: none;
            filter: drop-shadow(0 0 20px rgba(247, 147, 26, 0.3));
        }

        .bitcoin-icon:active { transform: scale(0.95); }

        /* Pasek postępu pod Bitcoinem */
        .cooldown-bar-container {
            width: 220px;
            height: 10px;
            background: #333;
            border-radius: 5px;
            margin: 20px auto;
            overflow: hidden;
        }

        #cooldown-bar {
            width: 100%;
            height: 100%;
            background: var(--btc-color);
            transition: width 0.1s linear;
        }

        .val-display {
            font-size: 2rem;
            font-weight: 800;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .sync-indicator { font-size: 1.2rem; min-width: 25px; }
        .fa-check { color: var(--pln-color); }
        .fa-times { color: #ff4757; }
        .fa-spinner { color: var(--btc-color); }

        input {
            width: 100%;
            padding: 12px;
            background: #000;
            border: 1px solid #444;
            border-radius: 10px;
            color: white;
            margin-bottom: 10px;
            text-align: center;
        }

        .exchange-btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btc-btn { background: var(--btc-color); color: white; }
        .pln-btn { background: var(--pln-color); color: white; }

        .floating-text {
            position: absolute;
            color: var(--btc-color);
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 0.6s ease-out forwards;
            font-size: 1.5rem;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }
    </style>
</head>
<body>

<div class="game-layout">
    <div class="side-panel">
        <h2 style="color: var(--pln-color)">Portfel PLN</h2>
        <div class="val-display">
            <span id="pln-val">0.00</span>
            <i class="sync-indicator fas" id="plnSync"></i>
        </div>
        <div id="plnStatusText" style="font-size: 0.8rem; margin-bottom: 20px;">Weryfikacja...</div>
        <input type="number" id="inputPln" placeholder="Wymień PLN (puste=wszystko)">
        <div style="font-size: 0.8rem; margin-bottom: 10px;" id="outPln">Otrzymasz: 0 BTC</div>
        <button class="exchange-btn pln-btn" id="btnPlnToBtc">Kup BTC</button>
    </div>

    <div class="center-panel">
        <div id="perunBTC" style="color: #666; font-weight: bold; margin-bottom: 10px;">KURS: ŁADOWANIE...</div>
        <div class="bitcoin-wrapper">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg" class="bitcoin-icon" id="btcClicker">
        </div>
        <div class="cooldown-bar-container">
            <div id="cooldown-bar"></div>
        </div>
        <p id="instruction" style="color: #444;">Klikaj! Naliczanie co 0.5s</p>
    </div>

    <div class="side-panel">
        <h2 style="color: var(--btc-color)">Portfel BTC</h2>
        <div class="val-display">
            <span id="btc-val">0.00000000</span>
            <i class="sync-indicator fas" id="btcSync"></i>
        </div>
        <div style="font-size: 0.8rem; margin-bottom: 20px; color: #666;">Autozapis: <span id="auto-save-timer">30</span>s</div>
        <input type="number" id="inputBtc" placeholder="Wymień BTC (puste=wszystko)">
        <div style="font-size: 0.8rem; margin-bottom: 10px;" id="outBtc">Otrzymasz: 0 PLN</div>
        <button class="exchange-btn btc-btn" id="btnBtcToPln">Sprzedaj BTC</button>
    </div>
</div>

<script src="https://suspicioyt.github.io/perunverse/data/data.js"></script>
<script src="https://suspicioyt.github.io/perunverse/data/localData.js"></script>

<script>
    (async function() {
        let isSyncing = false;
        let btc = parseFloat(getLocalData('gameverse', 'bitcoin')) || 0;
        let pln = 0;
        let rate = 350000;
        let autoSaveSec = 30;

        // Rate limiting variables
        const COOLDOWN_MS = 50; 
        let lastNaliczenieTime = 0;

        const plnSync = document.getElementById('plnSync');
        const plnStatusText = document.getElementById('plnStatusText');
        const cooldownBar = document.getElementById('cooldown-bar');
        const btcClicker = document.getElementById('btcClicker');

        async function checkDatabase() {
            if (window.userData) {
                await window.userData.initializeUserData();
                const cloudData = window.userData.getData('profile', 'money');
                if (cloudData === null || cloudData === undefined) {
                    plnSync.className = 'sync-indicator fas fa-times';
                    plnStatusText.textContent = "BRAK WPISU W BAZIE";
                } else {
                    pln = parseFloat(cloudData);
                    plnSync.className = 'sync-indicator fas fa-check';
                    plnStatusText.textContent = "POŁĄCZONO";
                }
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('btc-val').textContent = btc.toFixed(8);
            document.getElementById('pln-val').textContent = pln.toFixed(2);
            
            const iBtc = document.getElementById('inputBtc').value;
            const bVal = iBtc === "" ? btc : parseFloat(iBtc) || 0;
            document.getElementById('outBtc').textContent = `Otrzymasz: ${(bVal * rate).toFixed(2)} PLN`;

            const iPln = document.getElementById('inputPln').value;
            const pVal = iPln === "" ? pln : parseFloat(iPln) || 0;
            document.getElementById('outPln').textContent = `Otrzymasz: ${(pVal / rate).toFixed(8)} BTC`;
        }

        async function saveToCloud() {
            isSyncing = true;
            plnSync.className = 'sync-indicator fas fa-spinner fa-spin';
            try {
                if (window.userData) {
                    // Zapisujemy obie wartości do bazy
                    await window.userData.setData('profile', 'money', pln.toFixed(2));
                    // Opcjonalnie: jeśli masz pole na bitcoiny w bazie:
                    // await window.userData.setData('profile', 'bitcoin', btc.toFixed(8));
                    
                    plnSync.className = 'sync-indicator fas fa-check';
                    plnStatusText.textContent = "ZSYNCHRONIZOWANO";
                }
            } catch (e) {
                plnSync.className = 'sync-indicator fas fa-times';
                plnStatusText.textContent = "BŁĄD ZAPISU";
            } finally {
                isSyncing = false;
            }
        }

        // --- GŁÓWNA LOGIKA KLIKANIA ---
        btcClicker.addEventListener('click', (e) => {
            const now = Date.now();

            // Możesz klikać ile chcesz, ale nalicza tylko jeśli minęło 500ms
            if (now - lastNaliczenieTime >= COOLDOWN_MS) {
                lastNaliczenieTime = now;
                btc += 0.00000001;
                setLocalData('gameverse', 'bitcoin', btc.toFixed(8));
                updateUI();

                // Efekt wizualny naliczenia
                const float = document.createElement('div');
                float.className = 'floating-text';
                float.textContent = '+1 sat';
                float.style.left = (e.clientX - 20) + 'px';
                float.style.top = (e.clientY - 20) + 'px';
                document.body.appendChild(float);
                setTimeout(() => float.remove(), 600);

                // Reset paska cooldownu
                cooldownBar.style.transition = 'none';
                cooldownBar.style.width = '0%';
                setTimeout(() => {
                    cooldownBar.style.transition = `width ${COOLDOWN_MS}ms linear`;
                    cooldownBar.style.width = '100%';
                }, 10);
            }
        });

        // Autozapis co 30s
        setInterval(() => {
            autoSaveSec--;
            document.getElementById('auto-save-timer').textContent = autoSaveSec;
            if (autoSaveSec <= 0) {
                saveToCloud();
                autoSaveSec = 30;
            }
        }, 1000);

        document.getElementById('btnBtcToPln').addEventListener('click', async () => {
            const v = document.getElementById('inputBtc').value === "" ? btc : parseFloat(document.getElementById('inputBtc').value);
            if (v > 0 && v <= btc) { btc -= v; pln += v * rate; updateUI(); await saveToCloud(); }
        });

        document.getElementById('btnPlnToBtc').addEventListener('click', async () => {
            const v = document.getElementById('inputPln').value === "" ? pln : parseFloat(document.getElementById('inputPln').value);
            if (v > 0 && v <= pln) { pln -= v; btc += v / rate; updateUI(); await saveToCloud(); }
        });

        async function fetchRate() {
            try {
                const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=pln');
                const d = await r.json();
                rate = d.bitcoin.pln;
                document.getElementById('perunBTC').textContent = `KURS BTC: ${rate.toLocaleString()} PLN`;
            } catch (e) {}
            updateUI();
        }

        document.getElementById('inputBtc').addEventListener('input', updateUI);
        document.getElementById('inputPln').addEventListener('input', updateUI);

        await checkDatabase();
        await fetchRate();
        setInterval(fetchRate, 60000);
    })();
</script>
</body>
</html>