<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grow a Garden | Perun Gameverse</title>
    <link rel="icon" type="image/x-icon" href="https://suspicioyt.github.io/perunverse/logo/gameverse.png">
    <link rel="stylesheet" href="https://suspicioyt.github.io/perunverse/gameverse/style/public.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(to bottom, #a3e635, #f0f7fa);
            color: #2d3748;
            min-height: 100vh;
            padding: 1rem;
        }
        .garden-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
            background-color: #6d4c41;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            max-width: 500px;
        }
        .plot {
            width: 100%;
            aspect-ratio: 1/1;
            background-color: #4a3728;
            border: 3px solid #3e2f22;
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 1.5rem;
            transition: transform 0.3s, background-color 0.3s;
            position: relative;
        }
        .plot:hover .growth-status {
            display: block;
        }
        .growth-status {
            display: none;
            position: absolute;
            top: -3.5rem;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            z-index: 10;
            width: 120px;
        }
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.25rem;
        }
        .progress-bar-fill {
            height: 100%;
            background: #48bb78;
            transition: width 0.3s;
        }
        .planted { background-color: #2f855a; }
        .ready {
            background-color: #f6e05e;
            animation: pulse 1.5s infinite;
        }
        .withered { background-color: #744210; filter: grayscale(70%); }
        .low-fertility { background-color: #6b4e31; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .plant-size-small { transform: scale(0.8); }
        .plant-size-medium { transform: scale(1.2); }
        .plant-size-large { transform: scale(1.5); }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            max-width: 90%;
            width: 500px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .npc {
            cursor: pointer;
            font-size: 2.5rem;
            margin: 0.5rem;
            transition: transform 0.2s;
        }
        .npc:hover {
            transform: scale(1.1);
        }
        #events {
            margin-top: 1rem;
            font-style: italic;
            color: #9f1239;
            min-height: 1.5rem;
        }
        .section {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
            width: 100%;
            max-width: 600px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }
        th, td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: left;
            position: relative;
        }
        th {
            background-color: #48bb78;
            color: white;
        }
        .seed-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .seed-row:hover {
            background-color: #e6fffa;
        }
        .seed-row.selected {
            background-color: #9ae6b4;
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
        }
        .tooltip {
            visibility: hidden;
            position: absolute;
            top: -100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 10;
        }
        .seed-row:hover .tooltip {
            visibility: visible;
        }
        button {
            transition: all 0.2s;
        }
        button:hover:not(:disabled) {
            transform: scale(1.05);
        }
        @media (max-width: 400px) {
            .garden-grid {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            }
            .plot {
                font-size: 1rem;
            }
            .modal-content {
                width: 95%;
            }
        }
    </style>
</head>

<body class="flex flex-col items-center">
    <h1 class="text-4xl font-bold text-green-700 mb-6">Grow a Garden</h1>
    <div id="stats" class="section">PieniƒÖdze: 50 z≈Ç | Woda: 50 | Naw√≥z: 0 | Pogoda: S≈Çonecznie</div>
    <div id="controls" class="section">
        <h3 class="text-xl font-semibold">Akcje</h3>
        <div class="flex flex-wrap justify-center gap-2">
            <button id="deselectSeed" class="bg-blue-600 text-white px-4 py-2 rounded-lg hidden" onclick="deselectSeed()">Odznacz nasiona</button>
            <button class="bg-yellow-600 text-white px-4 py-2 rounded-lg" onclick="applyFertilizer()">U≈ºyj nawozu</button>
            <button class="bg-gray-600 text-white px-4 py-2 rounded-lg" onclick="resetGame()">Resetuj grƒô</button>
            <button class="bg-purple-600 text-white px-4 py-2 rounded-lg" onclick="openModal('tutorial')">Poradnik</button>
        </div>
    </div>
    <div id="inventory" class="section">
        <h3 class="text-xl font-semibold">Ekwipunek</h3>
        <table>
            <tr><th>Kategoria</th><th>Przedmiot</th><th>Ilo≈õƒá</th><th>Warto≈õƒá</th></tr>
        </table>
    </div>
    <div id="npcs" class="flex justify-center gap-4">
        <span class="npc" onclick="openModal('buyer')">üßë‚Äçüåæ</span>
        <span class="npc" onclick="openModal('seller')">üßë‚Äçüíº</span>
    </div>
    <div id="events"></div>
    <div id="garden" class="garden-grid"></div>
    <div id="buyerModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold">KupujƒÖcy üßë‚Äçüåæ</h3>
            <p>Wybierz plon do sprzeda≈ºy:</p>
            <select id="buyerCropSelect" class="border p-2 rounded-lg w-full"></select>
            <p id="buyerPrice" class="my-2"></p>
            <p id="totalValue" class="my-2"></p>
            <div class="flex justify-center gap-2">
                <button class="bg-green-600 text-white px-4 py-2 rounded-lg" onclick="sellSelectedCrop()">Sprzedaj wybrany</button>
                <button class="bg-green-600 text-white px-4 py-2 rounded-lg" onclick="sellAllCrops()">Sprzedaj wszystkie</button>
                <button class="bg-gray-600 text-white px-4 py-2 rounded-lg" onclick="closeModal('buyer')">Zamknij</button>
            </div>
        </div>
    </div>
    <div id="sellerModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold">Sprzedawca üßë‚Äçüíº</h3>
            <p>Kup nasiona lub zasoby:</p>
            <div class="grid grid-cols-1 gap-4" id="sellerSeeds"></div>
            <div>
                <h4 class="text-lg font-medium">Zasoby</h4>
                <div class="flex flex-wrap justify-center gap-2 mt-2">
                    <button class="bg-green-600 text-white px-4 py-2 rounded-lg" onclick="buyFertilizer(75)">Naw√≥z (75 z≈Ç)</button>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg" onclick="buyWater(30)">Woda (30 z≈Ç)</button>
                </div>
            </div>
            <button class="bg-gray-600 text-white px-4 py-2 rounded-lg mt-4" onclick="closeModal('seller')">Zamknij</button>
        </div>
    </div>
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold">Poradnik</h3>
            <p class="text-left">
                <strong>Witaj w Grow a Garden!</strong><br>
                1. <strong>Kup nasiona</strong>: Kliknij sprzedawcƒô (üßë‚Äçüíº) i kup nasiona.<br>
                2. <strong>Wybierz nasiona</strong>: Kliknij nasiona w ekwipunku, aby je wybraƒá.<br>
                3. <strong>Sadzenie</strong>: Kliknij pustƒÖ dzia≈Çkƒô, aby zasadziƒá (przytrzymaj Shift dla wielu dzia≈Çek). Potrzebujesz wody i ≈ºyznej gleby.<br>
                4. <strong>Zbieranie</strong>: Kliknij gotowe ro≈õliny (≈º√≥≈Çte) w ciƒÖgu 10s, inaczej uschnƒÖ.<br>
                5. <strong>Sprzeda≈º</strong>: U≈ºyj kupujƒÖcego (üßë‚Äçüåæ) lub przycisku "Sprzedaj wszystkie".<br>
                6. <strong>Zasoby</strong>: Kup wodƒô (30 z≈Ç za 50) i naw√≥z (75 z≈Ç) u sprzedawcy.<br>
                7. <strong>Pogoda</strong>: Wp≈Çywa na wzrost i ryzyko uschniƒôcia.<br>
                8. <strong>Zdarzenia</strong>: Deszcz, susza, szkodniki i inne losowe wydarzenia.<br>
                <strong>Porada</strong>: U≈ºywaj nawozu, aby zwiƒôkszyƒá ≈ºyzno≈õƒá i przyspieszyƒá wzrost!
            </p>
            <button class="bg-gray-600 text-white px-4 py-2 rounded-lg mt-4" onclick="closeModal('tutorial')">Zamknij</button>
        </div>
    </div>
    <script src="https://suspicioyt.github.io/perunverse/data/data.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        // Initialize userData if available, but don't rely on it
        if (window.userData && typeof window.userData.initializeUserData === 'function') {
            try {
                await window.userData.initializeUserData();
            } catch (e) {
                console.error('Failed to initialize userData:', e);
            }
        }
        initGame();
    });

    const garden = document.getElementById('garden');
    const statsDisplay = document.getElementById('stats');
    const inventoryTable = document.getElementById('inventory').querySelector('table');
    const eventsDisplay = document.getElementById('events');
    const buyerModal = document.getElementById('buyerModal');
    const sellerModal = document.getElementById('sellerModal');
    const tutorialModal = document.getElementById('tutorialModal');
    const buyerCropSelect = document.getElementById('buyerCropSelect');
    const buyerPrice = document.getElementById('buyerPrice');
    const totalValue = document.getElementById('totalValue');
    const deselectSeedButton = document.getElementById('deselectSeed');
    const sellerSeedsContainer = document.getElementById('sellerSeeds');

    // Define all plants in a single array
    const plantData = [
        { id: 'carrot', name: 'Marchewka', emoji: 'üå±', growthTime: 60000, price: 2, weight: [5, 15], waterCost: 5, fertilityDrain: 10, seedCost: 15, witherChance: 0.05 },
        { id: 'sunflower', name: 'S≈Çonecznik', emoji: 'üåª', growthTime: 300000, price: 3, weight: [10, 30], waterCost: 8, fertilityDrain: 15, seedCost: 40, witherChance: 0.05 },
        { id: 'pumpkin', name: 'Dynia', emoji: 'üéÉ', growthTime: 1000000, price: 5, weight: [20, 50], waterCost: 12, fertilityDrain: 20, seedCost: 90, witherChance: 0.05 },
        { id: 'rose', name: 'R√≥≈ºa', emoji: 'üåπ', growthTime: 1800000, price: 8, weight: [10, 25], waterCost: 15, fertilityDrain: 25, seedCost: 130, witherChance: 0.05 },
        { id: 'tulip', name: 'Tulipan', emoji: 'üå∑', growthTime: 4000000, price: 10, weight: [8, 20], waterCost: 10, fertilityDrain: 18, seedCost: 200, witherChance: 0.07 },
        { id: 'moonflower', name: 'Ksiƒô≈ºycowy kwiat', emoji: 'üå∏üåô', growthTime: 6000000, price: 12, weight: [12, 30], waterCost: 18, fertilityDrain: 450, seedCost: 80, witherChance: 0.08 },
        { id: 'starfruitvine', name: 'Winoro≈õl gwiezdna', emoji: 'üçá‚≠ê', growthTime: 9000000, price: 20, weight: [20, 50], waterCost: 25, fertilityDrain: 1000, seedCost: 120, witherChance: 0.09 },
        { id: 'crystalcactus', name: 'Kryszta≈Çowy kaktus', emoji: 'üåµ‚ú®', growthTime: 18000000, price: 45, weight: [15, 40], waterCost: 20, fertilityDrain: 2250, seedCost: 100, witherChance: 0.1 },
        { id: 'lavender', name: 'Lawenda', emoji: 'üåø', growthTime: 12000000, price: 35, weight: [10, 25], waterCost: 12, fertilityDrain: 20, seedCost: 5000, witherChance: 0.12 },
        { id: 'dragonfruit', name: 'Smoczy owoc', emoji: 'üêâüçé', growthTime: 3600000, price: 100, weight: [15, 35], waterCost: 22, fertilityDrain: 32, seedCost: 10000, witherChance: 0.15 }
    ];

    // Initialize game state
    let gameState = {
        money: 50,
        water: 50,
        inventory: {
            seeds: Object.fromEntries(plantData.map(plant => [plant.id, 0])),
            crops: [],
            other: { fertilizer: 0 }
        },
        plots: Array(16).fill().map(() => ({ state: 'empty', type: '', fertility: 100 })),
        weather: 'sunny'
    };
    let selectedSeed = null;
    let isShiftHeld = false;

    // Sound effects
    const sounds = {
        plant: new Audio('https://freesound.org/data/previews/171/171671_2435888-lq.mp3'),
        harvest: new Audio('https://freesound.org/data/previews/345/345690_5938978-lq.mp3'),
        buy: new Audio('https://freesound.org/data/previews/184/184438_2391165-lq.mp3')
    };

    // Translate seed IDs to localized names
    function translateSeed(id) {
        const plant = plantData.find(p => p.id === id);
        return plant ? plant.name : 'Nieznany';
    }
    function getPlant(type) {
        const plant = plantData.find(p => p.id === type);
        if (!plant) {
            console.error(`Invalid plant type: ${type}`);
            return null;
        }
        return plant;
    }

    // Dynamically generate seller modal seed buttons
    function renderSellerModal() {
        sellerSeedsContainer.innerHTML = '<h4 class="text-lg font-medium">Nasiona</h4><div class="flex flex-wrap justify-center gap-2 mt-2"></div>';
        const seedButtonsContainer = sellerSeedsContainer.querySelector('div');
        plantData.forEach(plant => {
            const button = document.createElement('button');
            button.className = 'bg-green-600 text-white px-4 py-2 rounded-lg';
            button.innerHTML = `${plant.emoji} ${plant.name} (${plant.seedCost} z≈Ç)`;
            button.onclick = () => buySeed(plant.id, plant.seedCost);
            seedButtonsContainer.appendChild(button);
        });
    }

    // Load game state from localStorage or userData
    async function loadGame() {
        const defaultState = {
            money: 50,
            water: 50,
            inventory: {
                seeds: Object.fromEntries(plantData.map(plant => [plant.id, 0])),
                crops: [],
                other: { fertilizer: 0 }
            },
            plots: Array(16).fill().map(() => ({ state: 'empty', type: '', fertility: 100 })),
            weather: 'sunny'
        };
        try {
            let serverState = null;
            // Try to load from userData if available
            if (window.userData && typeof window.userData.getData === 'function') {
                serverState = await window.userData.getData('gameverse', 'growAGarden');
            }
            // Fallback to localStorage
            if (!serverState) {
                const localData = localStorage.getItem('growAGarden');
                serverState = localData ? JSON.parse(localData) : null;
            }
            if (serverState) {
                gameState = {
                    ...defaultState,
                    money: serverState.money || defaultState.money,
                    water: serverState.water || defaultState.water,
                    inventory: {
                        seeds: Object.fromEntries(
                            plantData.map(plant => [plant.id, serverState.inventory?.seeds?.[plant.id] || 0])
                        ),
                        crops: serverState.inventory?.crops?.filter(crop => plantData.some(p => p.id === crop.type)) || [],
                        other: { fertilizer: serverState.inventory?.other?.fertilizer || 0 }
                    },
                    plots: serverState.plots?.map(plot => ({
                        state: ['empty', 'planted', 'ready', 'withered'].includes(plot.state) ? plot.state : 'empty',
                        type: plantData.some(p => p.id === plot.type) ? plot.type : '',
                        fertility: Math.max(0, Math.min(100, plot.fertility || 100)),
                        growthTime: plot.growthTime || 0,
                        size: ['small', 'medium', 'large'].includes(plot.size) ? plot.size : '',
                        plantedTime: plot.plantedTime || 0,
                        harvestDeadline: plot.harvestDeadline || 0
                    })) || defaultState.plots,
                    weather: ['sunny', 'rainy', 'dry'].includes(serverState.weather) ? serverState.weather : 'sunny'
                };
                selectedSeed = plantData.some(p => p.id === serverState.selectedSeed) ? serverState.selectedSeed : null;
            } else {
                gameState = defaultState;
                selectedSeed = null;
                tutorialModal.style.display = 'flex';
            }
        } catch (e) {
            console.error('Error loading game state:', e);
            gameState = defaultState;
            selectedSeed = null;
            showEvent('B≈ÇƒÖd wczytywania gry. Zresetowano stan.');
            tutorialModal.style.display = 'flex';
        }
        updateStats();
        updateInventory();
        renderGarden();
        renderSellerModal();
        if (selectedSeed) deselectSeedButton.classList.remove('hidden');
    }

    // Save game state to localStorage or userData
    async function saveGame() {
        // Create a minimal game state to save
        const minimalState = {
            money: gameState.money,
            water: gameState.water,
            inventory: {
                seeds: gameState.inventory.seeds,
                crops: gameState.inventory.crops,
                other: gameState.inventory.other
            },
            plots: gameState.plots.map(plot => ({
                state: plot.state,
                type: plot.type,
                fertility: plot.fertility,
                growthTime: plot.growthTime || 0,
                size: plot.size || '',
                plantedTime: plot.plantedTime || 0,
                harvestDeadline: plot.harvestDeadline || 0
            })),
            weather: gameState.weather,
            selectedSeed: selectedSeed
        };
        try {
            // Try to save to userData if available
            if (window.userData && typeof window.userData.setData === 'function') {
                await window.userData.setData('gameverse', 'growAGarden', minimalState);
                console.log('Game state saved to server');
            }
            // Always save to localStorage as a fallback
            localStorage.setItem('growAGarden', JSON.stringify(minimalState));
            console.log('Game state saved to localStorage');
        } catch (e) {
            console.error('Error saving game state:', e);
            showEvent('B≈ÇƒÖd zapisywania gry.');
            // Save to localStorage as a fallback
            localStorage.setItem('growAGarden', JSON.stringify(minimalState));
        }
    }

    // Update stats display
    function updateStats() {
        const fertilizer = gameState.inventory?.other?.fertilizer || 0;
        const weatherText = gameState.weather === 'sunny' ? 'S≈Çonecznie' : gameState.weather === 'rainy' ? 'Deszczowo' : 'Sucho';
        statsDisplay.textContent = `PieniƒÖdze: ${gameState.money} z≈Ç | Woda: ${gameState.water} | Naw√≥z: ${fertilizer} | Pogoda: ${weatherText}`;
    }

    // Update inventory display
    function updateInventory() {
        while (inventoryTable.rows.length > 1) inventoryTable.deleteRow(1);
        if (gameState.inventory?.seeds) {
            for (let [type, count] of Object.entries(gameState.inventory.seeds).sort()) {
                const plant = plantData.find(p => p.id === type);
                if (count > 0 && plant) {
                    const row = inventoryTable.insertRow();
                    row.classList.add('seed-row');
                    if (selectedSeed === type) row.classList.add('selected');
                    row.addEventListener('click', () => selectSeed(type));
                    row.insertCell().textContent = 'Nasiona';
                    row.insertCell().innerHTML = `${plant.emoji} ${plant.name}`;
                    row.insertCell().textContent = count;
                    row.insertCell().textContent = '-';
                    const tooltip = document.createElement('span');
                    tooltip.classList.add('tooltip');
                    tooltip.textContent = `Koszt: ${plant.seedCost} z≈Ç, Czas wzrostu: ${(plant.growthTime / 1000)}s, Cena: ${plant.price} z≈Ç/g, Ryzyko uschniƒôcia: ${plant.witherChance * 100}%`;
                    row.cells[1].appendChild(tooltip);
                }
            }
        }
        if (gameState.inventory?.crops) {
            for (let crop of gameState.inventory.crops.sort((a, b) => a.type.localeCompare(b.type))) {
                const plant = plantData.find(p => p.id === crop.type);
                if (plant) {
                    const row = inventoryTable.insertRow();
                    row.insertCell().textContent = 'Plony';
                    row.insertCell().innerHTML = `${plant.emoji} ${plant.name}`;
                    row.insertCell().textContent = `${crop.weight}g`;
                    row.insertCell().textContent = `${crop.weight * plant.price} z≈Ç`;
                }
            }
        }
        if (gameState.inventory?.other?.fertilizer > 0) {
            const row = inventoryTable.insertRow();
            row.insertCell().textContent = 'Inne';
            row.insertCell().textContent = 'Naw√≥z';
            row.insertCell().textContent = gameState.inventory.other.fertilizer;
            row.insertCell().textContent = '-';
        }
    }

    // Render garden plots
    function renderGarden() {
        garden.innerHTML = '';
        gameState.plots.forEach((plot, index) => {
            const plotElement = document.createElement('div');
            plotElement.classList.add('plot');
            if (plot.state === 'planted') plotElement.classList.add('planted', `plant-size-${plot.size}`);
            if (plot.state === 'ready') plotElement.classList.add('ready', `plant-size-${plot.size}`);
            if (plot.state === 'withered') plotElement.classList.add('withered');
            if (plot.fertility < 50) plotElement.classList.add('low-fertility');
            const plant = plantData.find(p => p.id === plot.type);
            plotElement.textContent = plant ? plant.emoji : '';
            if (plot.state === 'planted') {
                const progress = Math.min(100, ((Date.now() - plot.plantedTime) / (plot.growthTime || 1)) * 100).toFixed(0);
                const status = document.createElement('div');
                status.classList.add('growth-status');
                status.innerHTML = `${progress}% (≈ªyzno≈õƒá: ${plot.fertility}%)<div class="progress-bar"><div class="progress-bar-fill" style="width: ${progress}%"></div></div>`;
                plotElement.appendChild(status);
            }
            plotElement.addEventListener('click', (e) => handlePlotClick(index, e));
            garden.appendChild(plotElement);
        });
    }

    // Select seed for planting
    function selectSeed(type) {
        const plant = plantData.find(p => p.id === type);
        if (!plant) {
            console.error(`Invalid seed type selected: ${type}`);
            showEvent('Nieprawid≈Çowy typ nasiona!');
            return;
        }
        if (gameState.inventory?.seeds?.[type] > 0) {
            selectedSeed = type;
            deselectSeedButton.classList.remove('hidden');
            updateInventory();
            showEvent(`Wybrano nasiona: ${translateSeed(type)}`);
            playSound(sounds.buy);
        } else {
            showEvent(`Brak nasion ${translateSeed(type)}!`);
        }
    }

    // Deselect seed
    function deselectSeed() {
        selectedSeed = null;
        deselectSeedButton.classList.add('hidden');
        updateInventory();
        showEvent('Odznaczono nasiona.');
    }

    // Buy seeds
    async function buySeed(type, cost) {
        if (gameState.money >= cost) {
            gameState.money -= cost;
            gameState.inventory.seeds[type]++;
            updateStats();
            updateInventory();
            await saveGame();
            showEvent(`Kupiono nasiona ${translateSeed(type)}!`);
            playSound(sounds.buy);
        } else {
            showEvent('NiewystarczajƒÖco pieniƒôdzy!');
        }
    }

    // Buy fertilizer
    async function buyFertilizer(cost) {
        if (gameState.money >= cost) {
            gameState.money -= cost;
            if (!gameState.inventory.other) gameState.inventory.other = { fertilizer: 0 };
            gameState.inventory.other.fertilizer++;
            updateStats();
            updateInventory();
            await saveGame();
            showEvent('Kupiono naw√≥z!');
            playSound(sounds.buy);
        } else {
            showEvent('NiewystarczajƒÖco pieniƒôdzy!');
        }
    }

    // Buy water
    async function buyWater(cost) {
        if (gameState.money >= cost) {
            gameState.money -= cost;
            gameState.water += 50;
            updateStats();
            await saveGame();
            showEvent('Kupiono wodƒô (+50)!');
            playSound(sounds.buy);
        } else {
            showEvent('NiewystarczajƒÖco pieniƒôdzy!');
        }
    }

    // Apply fertilizer
    async function applyFertilizer() {
        if (gameState.inventory?.other?.fertilizer > 0) {
            gameState.inventory.other.fertilizer--;
            gameState.plots.forEach(plot => {
                if (plot.state === 'planted') {
                    plot.growthTime = Math.max(plot.growthTime - 3000, 1000);
                }
                plot.fertility = Math.min(plot.fertility + 20, 100);
            });
            updateStats();
            updateInventory();
            await saveGame();
            showEvent('U≈ºyto nawozu! Ro≈õliny rosnƒÖ szybciej, ≈ºyzno≈õƒá wzros≈Ça.');
            playSound(sounds.plant);
        } else {
            showEvent('Brak nawozu!');
        }
    }

    // Handle plot click (planting, harvesting, clearing withered)
    async function handlePlotClick(index, event) {
        const plot = gameState.plots[index];
        if (plot.state === 'empty') {
            if (!selectedSeed) {
                showEvent('Wybierz nasiona z ekwipunku!');
                return;
            }
            const plant = plantData.find(p => p.id === selectedSeed);
            if (!plant) {
                console.error(`Invalid seed type: ${selectedSeed}`);
                showEvent('Nieprawid≈Çowy typ nasiona!');
                selectedSeed = null;
                deselectSeedButton.classList.add('hidden');
                updateInventory();
                return;
            }
            if (!gameState.inventory?.seeds?.[selectedSeed] || gameState.inventory.seeds[selectedSeed] <= 0) {
                showEvent(`Brak nasion ${translateSeed(selectedSeed)}!`);
                return;
            }
            if (gameState.water < plant.waterCost) {
                showEvent('Za ma≈Ço wody!');
                return;
            }
            if (plot.fertility < 20) {
                showEvent('Gleba jest za ma≈Ço ≈ºyzna! U≈ºyj nawozu.');
                return;
            }
            const plotsToPlant = isShiftHeld ? gameState.plots.filter(p => p.state === 'empty') : [plot];
            let plantedCount = 0;
            plotsToPlant.forEach(p => {
                if (gameState.inventory.seeds[selectedSeed] > 0 && gameState.water >= plant.waterCost && p.fertility >= 20) {
                    gameState.inventory.seeds[selectedSeed]--;
                    gameState.water -= plant.waterCost;
                    p.state = 'planted';
                    p.type = selectedSeed;
                    p.growthTime = plant.growthTime;
                    p.plantedTime = Date.now();
                    p.size = ['small', 'medium', 'large'][Math.floor(Math.random() * 3)];
                    p.fertility -= plant.fertilityDrain;
                    p.harvestDeadline = 0;
                    plantedCount++;
                }
            });
            if (plantedCount > 0) {
                updateStats();
                updateInventory();
                await saveGame();
                renderGarden();
                showEvent(`Zasadzono ${plantedCount} x ${translateSeed(selectedSeed)}!`);
                playSound(sounds.plant);
            } else {
                showEvent('Nie mo≈ºna zasadziƒá: brak zasob√≥w!');
            }
        } else if (plot.state === 'ready') {
            await harvest(index);
        } else if (plot.state === 'withered') {
            plot.state = 'empty';
            plot.type = '';
            plot.size = '';
            plot.growthTime = 0;
            plot.plantedTime = 0;
            plot.harvestDeadline = 0;
            renderGarden();
            await saveGame();
            showEvent('Usuniƒôto uschniƒôtƒÖ ro≈õlinƒô.');
        }
    }

    // Check plant growth
    async function checkGrowth() {
        const now = Date.now();
        let changed = false;
        gameState.plots.forEach((plot, index) => {
            if (plot.state === 'planted' && now - plot.plantedTime >= plot.growthTime) {
                const plant = plantData.find(p => p.id === plot.type);
                const witherChance = plant ? plant.witherChance * (gameState.weather === 'dry' ? 1.5 : gameState.weather === 'rainy' ? 0.5 : 1) : 0.1;
                plot.state = Math.random() < witherChance ? 'withered' : 'ready';
                if (plot.state === 'ready') {
                    plot.harvestDeadline = now + 10000;
                }
                changed = true;
            } else if (plot.state === 'ready' && plot.harvestDeadline && now > plot.harvestDeadline) {
                plot.state = 'withered';
                plot.harvestDeadline = 0;
                showEvent(`${translateSeed(plot.type)} usch≈Ça z powodu op√≥≈∫nienia w zbiorze!`);
                changed = true;
            }
        });
        if (changed) {
            await saveGame();
            renderGarden();
        }
    }

    // Harvest crops
    async function harvest(index) {
        const plot = gameState.plots[index];
        const plant = plantData.find(p => p.id === plot.type);
        if (!plant) {
            console.error(`Invalid plant type in harvest: ${plot.type}`);
            return;
        }
        const weightRange = plant.weight;
        const weight = Math.floor(Math.random() * (weightRange[1] - weightRange[0] + 1)) + weightRange[0];
        gameState.inventory.crops.push({ type: plot.type, weight });
        plot.state = 'empty';
        plot.type = '';
        plot.size = '';
        plot.growthTime = 0;
        plot.plantedTime = 0;
        plot.harvestDeadline = 0;
        renderGarden();
        updateInventory();
        await saveGame();
        showEvent(`Zebrano ${translateSeed(plot.type)} o wadze ${weight}g!`);
        playSound(sounds.harvest);
    }

    // Sell all crops
    async function sellCrops() {
        let totalMoney = 0;
        if (gameState.inventory?.crops) {
            gameState.inventory.crops.forEach(crop => {
                const plant = plantData.find(p => p.id === crop.type);
                totalMoney += crop.weight * (plant ? plant.price : 0);
            });
            gameState.money += totalMoney;
            gameState.inventory.crops = [];
            updateStats();
            updateInventory();
            await saveGame();
            showEvent(`Sprzedano wszystkie plony za ${totalMoney} z≈Ç!`);
            playSound(sounds.buy);
        } else {
            showEvent('Brak plon√≥w do sprzeda≈ºy!');
        }
    }

    // Open modal
    function openModal(type) {
        if (type === 'buyer') {
            buyerCropSelect.innerHTML = '';
            if (!gameState.inventory?.crops || gameState.inventory.crops.length === 0) {
                buyerCropSelect.innerHTML = '<option>Brak plon√≥w</option>';
                buyerPrice.textContent = '';
                totalValue.textContent = '';
            } else {
                gameState.inventory.crops.forEach((crop, index) => {
                    const plant = plantData.find(p => p.id === crop.type);
                    if (plant) {
                        const option = document.createElement('option');
                        option.value = index;
                        option.innerHTML = `${plant.emoji} ${translateSeed(crop.type)} (${crop.weight}g)`;
                        buyerCropSelect.appendChild(option);
                    }
                });
                updateBuyerPrice();
                const total = gameState.inventory.crops.reduce((sum, crop) => {
                    const plant = plantData.find(p => p.id === crop.type);
                    return sum + crop.weight * (plant ? plant.price : 0);
                }, 0);
                totalValue.textContent = `Ca≈Çkowita warto≈õƒá plon√≥w: ${total} z≈Ç`;
            }
            buyerModal.style.display = 'flex';
        } else if (type === 'seller') {
            sellerModal.style.display = 'flex';
        } else if (type === 'tutorial') {
            tutorialModal.style.display = 'flex';
        }
    }

    // Close modal
    function closeModal(type) {
        if (type === 'buyer') {
            buyerModal.style.display = 'none';
        } else if (type === 'seller') {
            sellerModal.style.display = 'none';
        } else if (type === 'tutorial') {
            tutorialModal.style.display = 'none';
        }
    }

    // Update buyer modal price
    function updateBuyerPrice() {
        const index = buyerCropSelect.value;
        if (index && gameState.inventory?.crops?.[index]) {
            const crop = gameState.inventory.crops[index];
            const plant = plantData.find(p => p.id === crop.type);
            const price = crop.weight * (plant ? plant.price : 0);
            buyerPrice.textContent = `Cena sprzeda≈ºy: ${price} z≈Ç`;
        } else {
            buyerPrice.textContent = '';
        }
    }

    // Sell selected crop
    async function sellSelectedCrop() {
        const index = buyerCropSelect.value;
        if (index && gameState.inventory?.crops?.[index]) {
            const crop = gameState.inventory.crops[index];
            const plant = plantData.find(p => p.id === crop.type);
            const price = crop.weight * (plant ? plant.price : 0);
            gameState.money += price;
            gameState.inventory.crops.splice(index, 1);
            updateStats();
            updateInventory();
            await saveGame();
            showEvent(`Sprzedano ${translateSeed(crop.type)} za ${price} z≈Ç!`);
            playSound(sounds.buy);
            openModal('buyer');
        }
    }

    // Sell all crops in buyer modal
    async function sellAllCrops() {
        let totalMoney = 0;
        if (gameState.inventory?.crops) {
            gameState.inventory.crops.forEach(crop => {
                const plant = plantData.find(p => p.id === crop.type);
                totalMoney += crop.weight * (plant ? plant.price : 0);
            });
            gameState.money += totalMoney;
            gameState.inventory.crops = [];
            updateStats();
            updateInventory();
            await saveGame();
            showEvent(`Sprzedano wszystkie plony za ${totalMoney} z≈Ç!`);
            playSound(sounds.buy);
            closeModal('buyer');
        } else {
            showEvent('Brak plon√≥w do sprzeda≈ºy!');
        }
    }

    // Random events and weather
    async function randomEvent() {
        if (Math.random() < 0.02) {
            const weathers = ['sunny', 'rainy', 'dry'];
            gameState.weather = weathers[Math.floor(Math.random() * weathers.length)];
            updateStats();
            showEvent(`Pogoda zmieni≈Ça siƒô na ${gameState.weather === 'sunny' ? 's≈ÇonecznƒÖ' : gameState.weather === 'rainy' ? 'deszczowƒÖ' : 'suchƒÖ'}!`);
            if (gameState.weather === 'rainy') {
                gameState.plots.forEach(plot => {
                    if (plot.state === 'planted') plot.growthTime = Math.max(plot.growthTime - 4000, 1000);
                });
                showEvent('Deszcz przyspiesza wzrost ro≈õlin!');
            }
            await saveGame();
        }
        if (Math.random() < 0.01) {
            const events = [
                () => {
                    gameState.plots.forEach(plot => {
                        if (plot.state === 'planted' && Math.random() < 0.3) plot.state = 'withered';
                    });
                    showEvent('Susza! Niekt√≥re ro≈õliny usch≈Çy.');
                    renderGarden();
                },
                () => {
                    gameState.plots.forEach(plot => {
                        if (plot.state === 'planted' && Math.random() < 0.2) plot.state = 'withered';
                    });
                    showEvent('Szkodniki zaatakowa≈Çy! Niekt√≥re ro≈õliny usch≈Çy.');
                    renderGarden();
                },
                () => {
                    if (gameState.inventory?.crops?.length > 0) {
                        const stolen = gameState.inventory.crops.splice(0, Math.floor(gameState.inventory.crops.length / 2));
                        showEvent(`Z≈Çodzieje ukradli ${stolen.length} plon√≥w!`);
                        updateInventory();
                    } else {
                        showEvent('Z≈Çodzieje przyszli, ale nie mieli co ukra≈õƒá.');
                    }
                },
                () => {
                    gameState.money += 10;
                    showEvent('Znalaz≈Çe≈õ 10 z≈Ç w ogrodzie!');
                }
            ];
            events[Math.floor(Math.random() * events.length)]();
            await saveGame();
        }
    }

    // Display events
    function showEvent(message) {
        eventsDisplay.textContent = message;
        setTimeout(() => { eventsDisplay.textContent = ''; }, 4000);
    }

    // Reset game
    async function resetGame() {
        gameState = {
            money: 50,
            water: 50,
            inventory: {
                seeds: Object.fromEntries(plantData.map(plant => [plant.id, 0])),
                crops: [],
                other: { fertilizer: 0 }
            },
            plots: Array(16).fill().map(() => ({ state: 'empty', type: '', fertility: 100 })),
            weather: 'sunny'
        };
        selectedSeed = null;
        deselectSeedButton.classList.add('hidden');
        updateStats();
        updateInventory();
        renderGarden();
        renderSellerModal();
        await saveGame();
        showEvent('Gra zresetowana!');
        tutorialModal.style.display = 'flex';
    }

    // Handle Shift key for batch planting
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Shift') isShiftHeld = true;
    });
    document.addEventListener('keyup', (e) => {
        if (e.key === 'Shift') isShiftHeld = false;
    });

    // Sound control
    let isSoundEnabled = false;
    document.addEventListener('click', () => {
        isSoundEnabled = true;
    }, { once: true });
    function playSound(sound) {
        if (isSoundEnabled) {
            sound.play().catch(() => {});
        }
    }

    // Initialize game
    async function initGame() {
        await loadGame();
        buyerCropSelect.addEventListener('change', updateBuyerPrice);
        setInterval(async () => {
            await checkGrowth();
            await randomEvent();
        }, 1000);
    }
</script>
</body>
</html>